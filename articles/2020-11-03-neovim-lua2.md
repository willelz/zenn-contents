---
title: "Neovimã®ãŸã‚ã®Luaå…¥é–€ init.luaç·¨"
emoji: "ğŸ‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Neovim","Lua"]
published: true
---

## 2022-07-12 è¿½è¨˜
ã‹ãªã‚Šæƒ…å ±ãŒå¤ããªã£ã¦ã„ãŸã®ã§æ›´æ–°ã—ã¾ã—ãŸã€‚
`lua-intro`ã«ã‚‚ã‚ã‚‹[nanotee/nvim-lua-guide](https://github.com/nanotee/nvim-lua-guide)ã‚‚å‚ç…§ã—ã¦ãã ã•ã„ã€‚
æ—¥æœ¬èªè¨³ã‚‚ã‚ã‚Šã¾ã™ã€‚

## ã¯ã˜ã‚ã«
ä»Šå›ã¯`lua.txt`ã‹ã‚‰Luaã§è¨­å®šã‚’æ›¸ããŸã‚ã«å¿…è¦ãªã‚‚ã®ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚
NVIM v0.8.0-dev+604-gd8360e903ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

## ã©ã†ã‚„ã£ã¦èª­ã¿è¾¼ã‚€ã®ã‹

`.config/nvim/init.vim`ã®ä»£ã‚ã‚Šã«`.config/nvim/init.lua`ã‚’ç½®ãã¨ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦èª­ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚
`init.vim`ã¨`init.lua`ãŒåŒæ™‚ã«å­˜åœ¨ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¨ã—ã¦ä½¿ç”¨ã—ãŸã„å ´åˆã‚‚`runtimepath`å†…ã§`plugin/hoge.lua`ã®ã‚ˆã†ã«é…ç½®ã—ã€ä»Šã¾ã§ã®`.vim`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ãæ›ãˆã‚Œã°è‡ªå‹•ã§èª­ã¿è¾¼ã‚“ã§ãã‚Œã¾ã™ã€‚
(Vim scriptã‚’ç½®ãæ›ãˆã‚‹ç›®çš„ãªã‚‰ã‚‚ã†`setup()`ã¯å¿…é ˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚)

ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’é…ç½®ã—ãŸã„å ´åˆã¯ã€`runtimepath`å†…ã®`lua`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ãã¨ã€Luaã®`require`ã‹ã‚‰èª­ã¿è¾¼ã‚ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```lua
-- lua/hi.lua
return 'hi'
--

:lua print(require('hi"))
"hi
```

`lua/hello/init.lua`ã®ã‚ˆã†ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œã‚‹ã¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã§`require`ã§ãã¾ã™ã€‚

```lua
-- lua/hello/init.lua
return 'hello'
--

:lua print(require('hello')) 
"hello
```

## Luaã‹ã‚‰Vim script
æ˜”ã‹ã‚‰ã‚ã‚‹Nvim API(`:h api.txt`)ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã¨ã€å‰å›ã§ã¦ããŸ`lua-stdlib`ã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚
ã©ã¡ã‚‰ã‚‚vimãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ãŒã€ãƒ˜ãƒ«ãƒ—ã‚’æ¢ã™æ™‚ã¯`api.txt`ã¨`lua.txt`ã§åˆ¥ã‚Œã¦ã„ã‚‹ã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚
ã¾ãŸã€`api.txt`ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯Vim scriptãªã®ã§èª­ã¿å¤‰ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

`lua-stdlib`ã®æ–¹ã¯å½“ç„¶Luaç”¨ãªã®ã§APIã‚ˆã‚Šã¯ä½¿ã„ã‚„ã™ããªã£ã¦ã„ã¾ã™ã€‚

### é–¢æ•°
`vim.fn`ã§vimå´ã®é–¢æ•°ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚

```lua
-- vimçµ„è¾¼ã¿
vim.fn.abs(-10)

-- autoloadé–¢æ•°ã®å ´åˆ
vim.fn['dein#update']()
```

```lua
-- API
print( tostring( vim.api.nvim_get_current_line() ) )
```

`vim.api`ã¯ãƒ†ãƒ¼ãƒ–ãƒ«ãªã®ã§å°‘ã—ã‚¿ã‚¤ãƒ—æ•°ã‚’æ¸›ã‚‰ã›ã¾ã™ã€‚

```lua
local api = vim.api
api.nvim_buf_line_count(0)
```

### EXã‚³ãƒãƒ³ãƒ‰
æ–‡å­—åˆ—ãŒEXã‚³ãƒãƒ³ãƒ‰ã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
ä½•ã§ã‚‚ã§ãã‚‹æœ€çµ‚æ‰‹æ®µã§ã™ã€‚

```lua
vim.cmd('echo 1234')
```

### å¤‰æ•°
`vim.g.loaded_netrw = 1`ã®ç”¨ã«å¤‰æ•°ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚
ã‚¹ã‚³ãƒ¼ãƒ—ã¯g,b,w,t,vã¨ã€Vim scriptã¨åŒæ§˜ã§ã™ã€‚

ç’°å¢ƒå¤‰æ•°ã¯`env`ã‚’ä½¿ã„ã¾ã™ã€‚

```lua
print( vim.env.TERM )
```

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³
é€šå¸¸ã¯`:set`ç›¸å½“ã®ã“ã¨ãŒã§ãã‚‹`vim.opt`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
`:setlocal`ã¨`:setglobal`ã«å¯¾å¿œã™ã‚‹`vim.opt_local`ã¨`vim.opt_global`ã‚‚ã‚ã‚Šã¾ã™ã€‚
è©³ç´°ã¯`:h lua-vim-opt`ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

```lua
vim.opt.number = true
vim.opt.background = 'light'
vim.opt.wildignore = { '*.o', '*.a', '__pycache__' }
```

`:set +=`ãªã©ã®æ“ä½œã¯ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã„ã˜ã‚‹æ–¹æ³•ã¨é–¢æ•°ã‚’ä½¿ã†æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚

```lua
vim.opt.wildignore = vim.opt.wildignore + { "*.pyc", "node_modules" }
vim.opt.wildignore:append { "*.pyc", "node_modules" }
```

ã‚·ãƒ§ãƒ¼ãƒˆãƒãƒ³ãƒ‰ã¨ã—ã¦`vim.o`ã€`vim.bo`ã€`vim.wo`ã€`vim.go`ã¨ã„ã£ãŸå¤‰æ•°ã‚‚ã‚ã‚Šã¾ã™ã€‚

```
    lua            command      global_value       local_value
vim.o           :set                set                set
vim.bo/vim.wo   :setlocal            -                 set
vim.go          :setglobal          set                 -
```

### ãƒãƒƒãƒ”ãƒ³ã‚°
`nvim_set_keymap()`ã‹`vim.keymap.set()`ã‚’ä½¿ã„ã¾ã™ã€‚
è©³ç´°ã¯`:h lua-keymap`ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

`vim.keymap.set()`ã¯ãŠã‚‚ã—ã‚ã„é–¢æ•°ã§é€šå¸¸ã®`:map`ã¨ã¯å‹•ä½œãŒç•°ãªã‚Šã¾ã™ã€‚
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§remapãŒç„¡åŠ¹(noremap)ã«ãªã£ã¦ã„ã¦ã€`<Plug>`ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã¨è‡ªå‹•ã§æœ‰åŠ¹(map)ã«ãªã‚Šã¾ã™ã€‚
Luaã®é–¢æ•°ã‚’ãã®ã¾ã¾ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã®ã§åŸºæœ¬çš„ã«ã“ã¡ã‚‰ã‚’ä½¿ã†ã“ã¨ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚

```lua
-- ç­‰ä¾¡
vim.api.nvim_set_keymap( 'n', 'j', 'gj', {noremap = true} )
vim.keymap.set( 'n', 'j', 'gj' )

-- é–¢æ•°
vim.keymap.set('n', 'lhs', function() print("real lua function") end)
vim.keymap.set('n', 'asdf', require('jkl').my_fun)

-- è¤‡æ•°ã®ãƒ¢ãƒ¼ãƒ‰
vim.keymap.set({'n', 'v'}, '<leader>lr', vim.lsp.buf.references, { buffer=true })

-- <Plug>
vim.keymap.set('n', '[%', '<Plug>(MatchitNormalMultiBackward)')
```

### autocmd
`nvim_create_augroup()`ã¨`nvim_create_autocmd()`ã‚’ä½¿ã„ã¾ã™ã€‚

`nvim_create_augroup()`ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®`clear`ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚ªãƒ³ã«ãªã£ã¦ã„ã¦ã€ã‚ˆãã‚ã‚‹`:autocmd!`ã§å¤šé‡ç™»éŒ²ã‚’é˜²ãã¨ã„ã†ã®ãŒä¸è¦ã«ãªã£ã¦ã„ã¾ã™ã€‚
è©³ç´°ã¯`:h api-autocmd`ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

```lua
-- å¾“æ¥
vim.cmd('augroup lua')
vim.cmd('autocmd!')
vim.cmd('autocmd InsertEnter * echo "insert enter"')
vim.cmd('augroup END')

-- ä¸Šã¨åŒã˜
vim.api.nvim_create_augroup( 'lua', {} )
vim.api.nvim_create_autocmd( 'insertenter', {
  group = 'lua',
  callback = function() print( 'insert enter') end
})

-- Vim scriptã‚‚æ¸¡ã›ã¾ã™
vim.api.nvim_create_autocmd({"BufEnter", "BufWinEnter"}, {
  pattern = {"*.c", "*.h"},
  command = "echo 'Entering a C or C++ file'",
})
```

### ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ã‚³ãƒãƒ³ãƒ‰
`nvim_create_user_command()`ã‚’ä½¿ã„ã¾ã™ã€‚ãƒãƒƒãƒ•ã‚¡ã‚’æŒ‡å®šã§ãã‚‹`nvim_buf_create_user_command()`ã¨ã„ã†ã®ã‚‚ã‚ã‚Šã¾ã™ã€‚
è©³ç´°ã¯`:h api-command`ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

```lua
-- ç­‰ä¾¡
vim.cmd('command Hi echo "Hi!"')
vim.api.nvim_create_user_command( 'Hi', function() print( 'Hi!' ) end, {} )
```

ç™ºç«ã™ã‚‹ã«ã¯`vim.api.nvim_exec_autocmds()`ã‚’ä½¿ã„ã¾ã™ã€‚

```lua
vim.api.nvim_exec_autocmds( 'InsertEnter', {} )
```

## Vim scriptã‹ã‚‰Lua

### ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ `:lua-heredoc`
Vim scriptå†…ã«Luaã‚’ãã®ã¾ã¾åŸ‹ã‚è¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚
ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…ã®ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã¯ãã®ä¸­ã§ã—ã‹ä½¿ãˆã¾ã›ã‚“ã€‚

```vim
function! CurrentLineInfo()
lua << EOF
local linenr = vim.api.nvim_win_get_cursor(0)[1]
local curline = vim.api.nvim_buf_get_lines(0, linenr, linenr + 1, false)[1]
print(string.format("Current line [%d] has %d bytes",linenr, #curline))
EOF
endfunction
```

### v:lua
Luaã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªé–¢æ•°ã‚’å‘¼ã¶ã“ã¨ãŒã§ãã¾ã™ã€‚

```vim
lua << EOF
function Hello()
  print("Hello")
end
EOF

call v:lua.Hello()
"Hello
```

Vim scriptã®é–¢æ•°ã‚’è¨­å®šã™ã‚‹ã¨ã“ã‚ã«ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã§ã™ã€‚

```lua
vim.api.nvim_buf_set_option(0, 'omnifunc', 'v:lua.mymod.omnifunc')
```

v:luaã¯é–¢æ•°ã‚’å‘¼ã¶ã“ã¨ã—ã‹ã§ããšã€å¼ã§ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚

```vim
let g:Myvar = v:lua.myfunc        " Error
call SomeFunc(v:lua.mycallback)   " Error
let g:foo = v:lua                 " Error
let g:foo = v:['lua']             " Error
```

## ãŠã‚ã‚Šã«
ã‚ˆãä½¿ã„ãã†ãªç‰©ã®ç´¹ä»‹ã¯ä»¥ä¸Šã§ã™ã€‚
å„æ©Ÿèƒ½ã®ç´°ã‹ã„ã¨ã“ã‚ã¾ã§ã¯æ›¸ã„ã¦ã„ã¾ã›ã‚“ãŒã€Luaã‹ã‚‰è¨­å®šã§ãã‚‹ã‚‚ã®ãŒæƒã£ã¦ããŸå°è±¡ãŒã‚ã‚Šã¾ã™ã€‚

## å‚è€ƒ
- https://neovim.io/doc/user/lua.html
- https://neovim.io/doc/user/api
- https://github.com/nanotee/nvim-lua-guide
